zerops:
  - setup: backend
    build:
      base: nodejs@20
      prepareCommands:
        - sudo apk add git      
      buildCommands:
        - git clone https://github.com/Infisical/infisical.git
        - |
          cd infisical/backend
          npm i 
          npm run build
          npm ci --only-production
      deployFiles:
        - infisical/backend/~dist
        - infisical/backend/~node_modules
        - infisical/backend/~package.json
        - infisical/backend/~src/db
        - infisical/backend/~src/services
        - infisical/backend/~src/lib
    run:
      base: nodejs@20
      initCommands:
        - zsc execOnce -l SEED npm run seed
        - zsc execOnce $appVersionId npm run migration:latest
      start: npm start
      ports:
        - port: 8080
          httpSupport: true
      envVariables:
        NODE_ENV: production
        DB_CONNECTION_URI: ${db_connectionString}/${db_hostname}
        REDIS_URL: redis://${redis_hostname}:6379
