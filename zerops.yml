zerops:
  - setup: backend
    build:
      base: nodejs@20
      buildCommands:
        - git clone https://github.com/Infisical/infisical.git
        - |
          cd infisical/backend
          npm i 
          npm run build
          npm ci --only-production
      deployFiles:
        - infisical/backend/~dist
        - infisical/backend/~node_modules
        - infisical/backend/~package.json
        - infisical/backend/~src/db
        - infisical/backend/~src/services
        - infisical/backend/~src/lib
    run:
      base: nodejs@20
      start: npm start
      ports:
        - port: 8080
          httpSupport: true
      envVariables:
        NODE_ENV: production
        ENCRYPTION_KEY: ${db_ENCRYPTION_KEY}
        DB_CONNECTION_URI: ${db_connectionString}/${db_hostname}
        REDIS_URL: redis://${redis_hostname}:6379
        
  - setup: migrator
    build:
      base: nodejs@20   
      buildCommands:
        - git clone https://github.com/Infisical/infisical.git
        - cd infisical/backend && npm ci
      deployFiles:
        - infisical/backend/~
    run:
      base: nodejs@20
      envVariables:
        NODE_ENV: production
        ENCRYPTION_KEY: ${db_ENCRYPTION_KEY}
        DB_CONNECTION_URI: ${db_connectionString}/${db_hostname}      
      initCommands:
        - zsc execOnce $appVersionId npm run migration:latest
        - zsc execOnce -l SEED npm run seed  
      start: zsc noop
